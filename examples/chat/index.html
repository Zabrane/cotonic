<!DOCTYPE HTML>
<html>
    <head>
        <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="https://unpkg.com/turretcss@5.2.1/dist/turretcss.min.css">
        <link rel="stylesheet" href="style.css">
    </head>

    <body id="main">

        <nav class="nav-inline background-light-100 box-shadow-xxl">
            <ul>
                <li><a href="/" class="brand">
                        <img class="logo" src="/doc/favicon/apple-touch-icon.png" />
                        <span>Cotonic</span>
                    </a>
                </li>
                <li>
                    <span>Chat Example</span>
                </li>
            </ul>
        </nav>

        <main style="padding: 30px;">

        <div class="container">
            <p>
            Chat with any tab connected to the same broker and mqtt topic.
            </p>
            <a href="." target="_blank">Open another instance</a>
            <a href="https://github.com/cotonic/cotonic/tree/master/examples/chat" target="chat_example_code">Code</a>
        </div>

        <div class="container">

        <div class="chat-box box-shadow-xxl">
            <header class="background-primary-200 padding-xs">
                <form data-onsubmit-topic="chat/nick" data-onsubmit-cancel="preventDefault">
                    <div class="input-group">
                        <input id="nick" name="nick" value="" />
                        <button class="button button-primary" type="submit">Nickname</button>
                    </div>
                </form>
            </header>

            <div id="bubble-container" class="padding-xs" style="height: 400px; overflow-x: auto;">
            </div>

            <footer class="background-primary-200 padding-xs">
                <form data-onsubmit-topic="chat/message"
                      data-onsubmit-reset
                      data-onsubmit-cancel="preventDefault">

                    <div class="input-group">
                        <input name="message" placeholder="Type a message.." />
                        <button type="submit" class="button button-primary">Send</button>
                    </div>
                </form>
            </footer>
        </div>
        </div>

        
        <script type="text/javascript" src="/cotonic.js" data-base-worker-src="/cotonic-worker.js"></script>
    <script>
        const messages = [];
        const self_id = Math.floor(Math.random() * 1000000);

        const bubble_container = document.getElementById("bubble-container");
        const broker = "mqtt.eclipse.org"

        const presetNicks = ["Joe", "Mike", "Robert", "Micky", "Maus", "Donald", "Bruce", "Wayne", "Clark",
            "Kent", "Sarah", "Connor", "Mary", "Shelley", "Rosemary", "Wilma", "Louis", "Selina",
            "Barbara", "Gordon", "Herbert", "The Count"];

        let nick = presetNicks[Math.floor(Math.random() * presetNicks.length)];
        document.getElementById("nick").setAttribute("value", nick);

        cotonic.broker.publish("model/ui/insert/bubble-container", {
            priority: 10,
            initialData: view(),
            inner: true
        });

        function scrollToBottom() {
            bubble_container.scrollTop = bubble_container.scrollHeight
        }
        
        function updateView() {
            cotonic.broker.publish("model/ui/update/bubble-container", view());
            setTimeout(scrollToBottom, 20);  // Wait a little bit before scrolling
        }

        function systemMessage(msg) {
            messages.push({user_id: "$sys", msg: msg});
            updateView();
        }

        cotonic.broker.subscribe("chat/nick", function(m) {
            nick = m.payload.value.nick;
        });

        cotonic.broker.subscribe("chat/message", function(m) {
            const msg = m.payload.value.message;

            cotonic.broker.publish(cotonic.mqtt.fill("bridge/+broker/cotonic/chat", {broker: broker}),
                {msg: msg, user_id: self_id, nick: nick});
        })


        systemMessage("Connecting to " + broker);

        cotonic.mqtt_bridge.newBridge(broker, {protocol: "wss", controller_path: "/mqtt"});

        cotonic.broker.subscribe(cotonic.mqtt.fill("$bridge/+broker/status", {broker: broker}), function(m) {
            if(m.payload.hasOwnProperty("is_connected")) {
                systemMessage(m.payload.is_connected?"You are now connected, and subscribed to topic \"cotonic/chat\".":"Currently disconnected.");
            }
        })

        cotonic.broker.subscribe(cotonic.mqtt.fill("bridge/+broker/cotonic/chat", {broker: broker}),
            function(msg, inf) {
                /* 
                 * Filter out messages from the local broker. We want messages from 
                 * the remote broker only. These have the packet_id property set, but
                 * it could be null.
                 */
                if(!msg.hasOwnProperty("packet_id")) {
                    messages.push(msg.payload);
                    updateView();
                    return;
                } 

                let p = msg.payload;

                if(!(p.nick && p.msg))
                    return;

                if(p.user_id === self_id)
                    return;

                messages.push(p);
                updateView();
            });

        // Create the message view
        function view() {
            const tokens = [];

            let current_id = null;

            const div = {type: "open", tag: "div"}
            const close_div = {type: "close", tag: "div"}

            const container_self = {type: "open", tag: "div", attributes: ["class", "bubble-container self"]};
            const group_self = {type: "open", tag: "div", attributes: ["class", "bubble-group self"]};

            const container_other = {type: "open", tag: "div", attributes: ["class", "bubble-container other"]};
            const group_other = {type: "open", tag: "div", attributes: ["class", "bubble-group other"]};

            const container_sys = {type: "open", tag: "div", attributes: ["class", "bubble-container system"]};
            const group_sys = {type: "open", tag: "div", attributes: ["class", "bubble-group system"]};

            const close_span = {type: "close", tag: "span"};

            for(let i = 0; i < messages.length; i++) {
                const m = messages[i];

                if(m.user_id !== current_id) {
                    if(current_id !== null) {
                        // close the current container
                        tokens.push(close_div);
                        tokens.push(close_div);
                    }

                    if(m.user_id === self_id) {
                        tokens.push(container_self);
                        tokens.push(group_self);
                    } else if(m.user_id === "$sys") {
                        tokens.push(container_sys);
                        tokens.push(group_sys);
                    } else {
                        tokens.push(container_other);
                        tokens.push(group_other);
                        tokens.push(div);
                            tokens.push({type: "open", tag: "span", attributes: ["class", "bubble-name"]});
                            tokens.push({type: "text", data: m.nick});
                            tokens.push(close_span);
                        tokens.push(close_div);
                    }

                    current_id = m.user_id;
                }

                if(m.user_id === self_id) {
                    tokens.push({type: "open", tag: "div", attributes: ["class", "bubble self"]});
                } else if (m.user_id === "$sys") {
                    tokens.push({type: "open", tag: "div", attributes: ["class", "bubble system"]});
                } else {
                    tokens.push({type: "open", tag: "div", attributes: ["class", "bubble other"]});
                }
                    tokens.push({type: "open", tag: "span"});
                    tokens.push({type: "text", data: m.msg});
                    tokens.push(close_span);
                tokens.push(close_div);
            }

            return tokens;
        }

    </script>
    </body>
</html>
